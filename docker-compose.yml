version: "3.8"

services:
  # 1. PostgreSQL Database
  # Our main database for the tenant-service, credentials-service, etc.
  postgres_db:
    image: postgres:15
    container_name: local_postgres_db
    environment:
      POSTGRES_USER: devuser
      POSTGRES_PASSWORD: devpassword
      POSTGRES_DB: tenant_db
    ports:
      - "5432:5432" # Expose port 5432 to our host machine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - tenant_network

  # 2. RabbitMQ Message Queue
  # Our event bus for async communication
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: local_rabbitmq
    ports:
      - "5672:5672" # AMQP protocol port
      - "15672:15672" # Management UI port
    environment:
      RABBITMQ_DEFAULT_USER: devuser
      RABBITMQ_DEFAULT_PASS: devpassword
    networks:
      - tenant_network

  # 3. Redis Cache
  # For rate limiting, caching, etc.
  redis_cache:
    image: redis:7.2-alpine
    container_name: local_redis_cache
    ports:
      - "6379:6379"
    networks:
      - tenant_network

# Define a shared network so all containers can find each other
networks:
  tenant_network:
    driver: bridge

# Define volumes to persist data (so our DB isn't wiped on restart)
volumes:
  postgres_data:
