generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Tenant Service Schema ---

model Tenant {
  id        String   @id @default(cuid())
  name      String   @unique // e.g., "Acme Inc."
  subdomain String   @unique // e.g., "acme"
  status    TenantStatus @default(PROVISIONING)
  planId    String
  
  plan      Plan     @relation(fields: [planId], references: [id])
  users     User[]   // A tenant can have many users
  events    EventLog[]

  // Provisioning Steps Status
  dbStatus          StepStatus @default(PENDING)
  dnsStatus         StepStatus @default(PENDING)
  credentialsStatus StepStatus @default(PENDING)
  billingStatus     StepStatus @default(PENDING)
  notificationStatus StepStatus @default(PENDING)
  
  // Cancellation fields
  cancelledAt  DateTime?
  cancelReason String?
  
  deletedAt DateTime? // Soft delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  password     String?  // Nullable for OAuth-only users
  refreshToken String?  // For JWT refresh token rotation
  role         UserRole @default(USER)
  
  // OAuth fields
  provider     String?  // 'local', 'google', 'github'
  providerId   String?  // OAuth provider's user ID
  picture      String?  // Profile picture URL from OAuth
  
  // Email verification
  emailVerified    Boolean   @default(false)
  verificationToken String?
  verificationExpiry DateTime?
  
  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?
  
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  settings  Settings?
  
  deletedAt DateTime? // Soft delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerId])
}

model Plan {
  id        String   @id @default(cuid()) // e.g., "plan_basic", "plan_enterprise"
  name      String   @unique // e.g., "Basic", "Enterprise"
  maxUsers  Int
  maxApiKeys Int
  
  tenants   Tenant[] // A plan can be used by many tenants

  createdAt DateTime @default(now())
}

model EventLog {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  eventType String
  status    String   // "Success", "Warning", "Error"
  payload   Json?
  timestamp DateTime @default(now())
}

model Settings {
  id                 String   @id @default(cuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile
  firstName          String   @default("")
  lastName           String   @default("")
  
  // Notification Preferences
  emailNotifications Boolean  @default(true)
  failedJobAlerts    Boolean  @default(true)
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// --- Credentials Service Schema ---

model Credential {
  id        String   @id @default(cuid())
  tenantId  String   @unique // Foreign key to the tenant
  apiKey    String   @unique
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Enums ---

enum TenantStatus {
  PROVISIONING
  ACTIVE
  SUSPENDED
  FAILED
  CANCELLED
}

enum UserRole {
  ADMIN
  USER
}

enum StepStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  CANCELLED
}